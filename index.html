<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baseline - Audio Transcription Challenge</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      #transcriptions {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 200px;
      }
      .transcription-item {
        margin-bottom: 5px;
      }
      .keyword {
        background-color: yellow;
      }
    </style>
  </head>
  <body>
    <h1>Transcrição de Áudio</h1>
    <button id="startButton">Iniciar Transcrição</button>
    <div id="transcriptions"></div>

    <script>
      // --- NÃO MODIFICAR ESTA SEÇÃO ---
      // Simula uma API de reconhecimento de fala que recebe um ID de segmento e retorna uma transcrição.
      // A resposta tem um atraso aleatório para simular a variabilidade da rede.
      const mockSpeechRecognitionAPI = {
        transcriptions: [
          "Olá, doutor. Tenho sentido uma dor de cabeça persistente.",
          "A dor se concentra na parte de trás da minha cabeça e às vezes irradia para o meu pescoço.",
          "Começou há cerca de três dias.",
          "Não, não tive febre nem outros sintomas.",
          "Sim, tomei um analgésico, mas não ajudou muito.",
          "A dor piora quando fico muito tempo em frente ao computador.",
          "Certo, doutor. Farei os exames que o senhor pediu.",
          "Muito obrigado pela sua ajuda.",
          "Vou marcar o retorno assim que tiver os resultados.",
          "Tenha um bom dia.",
        ],
        fetchTranscription(segmentId) {
          return new Promise((resolve) => {
            const delay = Math.random() * 1200 + 200;
            setTimeout(() => {
              resolve({
                segmentId,
                text: this.transcriptions[segmentId] || "Fim da transcrição.",
              });
            }, delay);
          });
        },
      };

      async function getMedicalKeywords() {
        const response = await fetch(
          "https://iara-interview-data-65704389243.southamerica-east1.run.app"
        );
        const data = await response.json();
        return data.keywords;
      }
      // --- FIM DA SEÇÃO NÃO MODIFICÁVEL ---

      const btn = document.getElementById("startButton");
      const container = document.getElementById("transcriptions");
      let segmentCounter = 0;
      const maxSegments = 10;
      let medicalKeywords = [];

      getMedicalKeywords().then((terms) => {
        medicalKeywords = terms;
      });

      btn.addEventListener("click", () => {
        btn.disabled = true;
        btn.textContent = "Transcrevendo...";
        segmentCounter = 0;
        container.innerHTML = "";

        const interval = setInterval(() => {
          if (segmentCounter >= maxSegments) {
            clearInterval(interval);
            btn.disabled = false;
            btn.textContent = "Iniciar Transcrição";
            return;
          }

          mockSpeechRecognitionAPI
            .fetchTranscription(segmentCounter)
            .then((response) => {
              display(response);
            });

          segmentCounter++;
        }, 100); //Solicita um novo segmento a cada 100ms. Mantenha este intervalo (podendo alterar o código) para simular a gravação de diferentes segmentos de áudio.
      });

      function display({ segmentId, text }) {
        const p = document.createElement("p");
        p.innerHTML = `<b>Segmento ${segmentId + 1}:</b> ${processKwds(text)}`;
        p.className = "transcription-item";
        container.appendChild(p);
      }

      function processKwds(text) {
        let processedText = text;
        medicalKeywords.forEach((keyword) => {
          processedText = processedText.replace(
            new RegExp(`(${keyword})`, "gi"),
            `<span class="keyword">$1</span>`
          );
        });
        return processedText;
      }
    </script>
  </body>
</html>
